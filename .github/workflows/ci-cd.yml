name: ðŸ§  Wavefunction Approximation - CI/CD Pipeline

on:
  push:
    branches:
      - '**'   
  pull_request:
    branches:
      - '**'  

jobs:
  build:
    name: ðŸ›  Build Environment
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nbconvert nbformat pytest black isort flake8

  test:
    name: âœ… Lint & Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ðŸ“¦ Install Test Tools
        run: |
          pip install -r requirements.txt
          pip install black isort flake8 pytest

      - name: ðŸ” Lint Code
        run: |
          if [ -d "src" ]; then
            black --check src/
            isort --check-only src/
            flake8 src/
          else
            echo "âš ï¸ 'src/' folder not found. Skipping lint for src."
          fi

          if [ -d "notebooks" ]; then
            black --check notebooks/
            isort --check-only notebooks/
            flake8 notebooks/
          else
            echo "âš ï¸ 'notebooks/' folder not found. Skipping lint for notebooks."
          fi


      - name: ðŸ§ª Run Unit Tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/
          else
            echo "No tests found. Skipping."
          fi

      - name: ðŸ§  Execute Core Notebook
        run: |
          jupyter nbconvert --to notebook --execute notebooks/02_supervised_mlp_keras.ipynb --output executed_mlp.ipynb

  deploy:
    name: ðŸš€ Deploy Models
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' ||
       github.ref == 'refs/heads/dev' ||
       github.ref == 'refs/heads/staging')
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ðŸ“¦ Install TensorFlow
        run: |
          pip install tensorflow

      - name: ðŸš€ Simulate Deployment
        run: |
          mkdir -p deployment_output
          echo "ðŸš€ Environment: ${{ github.ref_name }}" > deployment_output/info.txt
          echo "ðŸ“¦ Model Hash: $(git rev-parse HEAD)" >> deployment_output/info.txt
          echo "ðŸ•’ Date: $(date)" >> deployment_output/info.txt

      - name: ðŸ“¤ Upload Deployment Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: model-${{ github.ref_name }}
          path: deployment_output/
